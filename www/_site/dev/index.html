<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="command line utility tool for moodle">
    <meta name="author" content="">
    <link rel="shortcut icon" href="">

    <title>moosh</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap-yeti.css" rel="stylesheet">

    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px;
      }
      .fa-times {
	color: #FF4136;
      }
      .fa-check {
	color: #2ECC40;
      }
      .anchor {
        display: block;
        height: 20px;
        margin-top: 20px;
        visibility: hidden;
      }
    </style>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">moosh</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="https://github.com/tmuras/moosh">github</a></li>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="/commands">commands</a></li>
            <li><a href="/dev">dev</a></li>
            <li><a href="/tutorials">tutorials</a></li>
          </ul>
          <a href="https://github.com/tmuras/moosh"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

<div class="container">

     <div class="row row-offcanvas row-offcanvas-right">


          <div class="col-xs-12 col-sm-9">
               <div class="">
                    <h1>Vagrant</h1>

<p>moosh comes with vagrant setup, which will give you the following moosh development environment:</p>

<ul>
<li>Ubuntu 16.04 with PHP 7</li>
<li>Apache configured to run as user vagrant (so no problems with the file permissions)</li>
<li>MySQL</li>
<li>Latest Moodle 3.1 installed</li>
<li>composer and moosh installed from source</li>
</ul>


<p>Simply:</p>

<pre><code>% git clone https://github.com/tmuras/moosh
% vagrant up
</code></pre>

<p>Your Moodle 3.1 is now available at http://192.168.33.10/moodle/ (login "admin", password "a").
 PhpMyAdmin URL is  http://192.168.33.10/phpmyadmin (MySQL login "root" and "mypassword).</p>

<p>Once you SSH into your box with:</p>

<pre><code> % vagrant ssh
</code></pre>

<p>You can run moosh inside the Moodle 3.1 installation:</p>

<pre><code> % cd /var/www/html/moodle
 % moosh user-list
</code></pre>

<p>The source code of moosh is under vagrant's home in /home/vagrant/moosh-src and calling "moosh"
 command will actually call /home/vagrant/moosh-src/moosh.php.</p>

<p>The directory /home/vagrant/moosh-src is shared with your host machine as "moosh-src", in directory
 where you have cloned the git repository. This is so you can use your favourite IDE on your host PC.</p>

<p>So - no excuses now - use pre-configured environment, develop some awesome moosh commands and send
 them to me!</p>

<h1>Performance information</h1>

<p>You can use global option -t (or long version --performance) to show extra performance information collected while the command runs:</p>

<pre><code>% mooshdev -t course-backup 2
... &lt;output cut&gt; ...
*** PERFORMANCE INFORMATION ***
Run from 2014-11-26T11:21:15+01:00 to 2014-11-26T11:21:16+01:00
Real time run 0.667 seconds
Server load before running the command: 0.14 0.16 0.16 1/584 6180
Server load after: 0.14 0.16 0.16 1/584 6180
Ticks: 67 user: 36 sys: 3 cuser: 0 csys: 0
Memory use before command run (internal/real): 19058864/19136512 (18.18 MB/18.25 MB)
Memory use after:  42252496/44040192 (40.30 MB/42.00 MB)
Memory peak: 43679224/45088768  (41.66 MB/43.00 MB)
*******************************
</code></pre>

<h1>Functional tests</h1>

<p>There are no unit tests implemented for testing moosh at the moment. Instead, a set of functional tests have been developed.
They are basically very simple bash scripts located in tests directory and named after command they test, e.g.:</p>

<pre><code>tests/file-list.sh
</code></pre>

<p>is used to test moosh file-list command.</p>

<p>All tests start with some common boilerplate:</p>

<pre><code>#!/bin/bash
source functions.sh

install_db
install_data
cd $MOODLEDIR
</code></pre>

<p>and then the test of the commmand is performed. Script should return (exit) with 0 if test is a success, with 1 otherwise. Here is test from file-list.sh:</p>

<pre><code>if moosh file-list id=6 | grep -w "grumpycat"; then
  exit 0
else
  exit 1
fi
</code></pre>

<p>All tests are then run with run-tests.php script, which in turn will generate status on the <a href="http://moosh-online.com/ci/">continues integration</a> page.</p>

<h2>Environment</h2>

<p>Notice in the test above that test suite assumes there is Moodle instance already setup and it contains a file called "grumpycat".
All commands will be run in a known, prepared environment with users, courses pre-created. “install moodle” means restoring Moodle DB and data from prepared snapshot.</p>

<h2>Set up &amp; run functional tests</h2>

<p>Some scripts use sudo chown command to operate on Moodle data, so to let them run without prompting for password add something like this to /etc/sudoers (use visudo to edit):</p>

<pre><code>%adm    ALL = NOPASSWD: /bin/chown, /bin/chmod
</code></pre>

<p>Then make sure your shell user is in group adm.</p>

<p>Create 2 directories for Moodle data, eg: ~/data/moosh-test/moodledata25 and ~/data/moosh-test/moodledata26. Give apache user write access to Moodle data dirs.</p>

<p>Create 2 empty databases: mooshtest_25 and mooshtest_26.</p>

<pre><code>#Get Moodle source code for 2.6 and 2.7
cd ~/www/html/moosh/
git clone https://github.com/moodle/moodle.git moodle25
cd moodle25
git checkout 3d176316cc1791e258a7c1b2118fd35976c9bcae
cp config-dist.php config.php
#configure settings in config.php down to &amp; including $CFG-&gt;dataroot

cd ~/www/html/moosh/
cp -r moodle25 moodle26
cd moodle26
git checkout ba05f57
cp config-dist.php config.php
#configure settings in config.php down to &amp; including $CFG-&gt;dataroot

git clone https://github.com/tmuras/moosh
cd moosh/tests
#Configure DATA,DB,DBUSER and DBPASSWORD in restore_all.sh and run it
./restore_all.sh
</code></pre>

<p>Login to Moodle instances (e.g. http://localhost/moosh/moodle26/) as 'admin' using password 'a' and check if it works OK after restore.</p>

<pre><code>cp config-template.sh config25.sh
cp config-template.sh config26.sh
#configure variables in config25.sh and config26.sh

#run tests, several should pass but some eventually fail:
php run-tests.php
</code></pre>

<h1>Contributing to moosh</h1>

<ol>
<li>Fork the project on github.</li>
<li>Follow "installation from Moodle git" section.</li>
<li>Look at existing plugins to see how they are done.</li>
<li><p>Create new plugin/update existing one. You can use moosh itself to generate a new command from a template for you:</p>

<p> moosh generate-moosh category-command</p></li>
<li><p>Update this README.md file with the example on how to use your plugin.</p></li>
<li>For the extra bonus create a functional test to cover your command.</li>
<li>Send me pull request.</li>
</ol>


<h1>Local commands</h1>

<p>You can add your own, local commands to moosh by storing them in the same structure as moosh does but under ~/.moosh.
For example, to create your custom command dev-mytest that works with any Moodle version, you would put it under:</p>

<pre><code>~/.moosh/Moosh/Command/Generic/Dev/MyTest.php
</code></pre>

               </div>
          </div>

          <div class="col-md-3">
               <div class="bs-sidebar hidden-print">
                         <p>Moodle development book:</p>
                         <a href="https://leanpub.com/moodle"><img src="/images/book.png" /></a>

               </div>
          </div>
     </div>

</div>
    </div><!-- /.container -->
    <hr>
<footer>
<div class="container">
    <p>&copy; <a href="https://github.com/tmuras">Tomasz Muras</a></p>
    </div>
</footer>
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

  </body>
</html>
